<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>マイジャグ5 設定判別</title>
</head>
<body>
  <h2>マイジャグ5 設定判別</h2>
  <label>総ゲーム数: <input type="number" id="games" /></label><br />
  <label>BIG回数: <input type="number" id="big" /></label><br />
  <label>REG回数: <input type="number" id="reg" /></label><br />
  <label>ぶどう回数: <input type="number" id="budou" /></label><br />
  <button onclick="judge()">判別</button>

  <div id="result"></div>

  <script>
    const settings = [1, 2, 3, 4, 5, 6];

    // 各設定の確率（適当なので必要に応じて修正してね）
    const rates = {
      big: [1/273.1, 1/270.8, 1/266.4, 1/254.0, 1/240.1, 1/229.1],
      reg: [1/409.6, 1/385.5, 1/336.1, 1/290.0, 1/268.6, 1/229.1],
      budou: [1/5.88, 1/5.84, 1/5.80, 1/5.75, 1/5.75, 1/5.65]
    };

    // log(n!) の近似（Lanczos近似）
    function logGamma(z) {
    const g = 7;
    const p = [
      0.99999999999980993, 676.5203681218851, -1259.1392167224028,
      771.32342877765313, -176.61502916214059,
      12.507343278686905, -0.13857109526572012,
      9.9843695780195716e-6, 1.5056327351493116e-7
    ];

    if (z < 0.5) {
      return Math.log(Math.PI) - Math.log(Math.sin(Math.PI * z)) - logGamma(1 - z);
    }

    z -= 1;
    let x = p[0];
    for (let i = 1; i < g + 2; i++) {
      x += p[i] / (z + i);
    }

    const t = z + g + 0.5;
    return 0.5 * Math.log(2 * Math.PI) + (z + 0.5) * Math.log(t) - t + Math.log(x);
  }

  function logMultinomialLikelihood(k, n, p) {
    if (n === 0 || p <= 0 || p >= 1 || k > n) return 0;
    const q = 1 - p;
    return logGamma(n + 1) - logGamma(k + 1) - logGamma(n - k + 1) +
           k * Math.log(p) + (n - k) * Math.log(q);
  }

    // 多項分布のlog尤度
    function logMultinomialLikelihood(k, n, p) {
      if (n === 0 || p <= 0 || p >= 1 || k > n) return 0;
      const q = 1 - p;
      return logGamma(n + 1) - logGamma(k + 1) - logGamma(n - k + 1) +
             k * Math.log(p) + (n - k) * Math.log(q);
    }

    function judge() {
      const n = parseInt(document.getElementById("games").value);
      const resultDiv = document.getElementById("result");

      const inputData = {
        big: parseInt(document.getElementById("big").value),
        reg: parseInt(document.getElementById("reg").value),
        budou: parseInt(document.getElementById("budou").value)
      };

      // 各設定ごとのlog尤度
      let logLs = settings.map((_, i) => {
        let total = 0;
        for (const key in inputData) {
          const k = inputData[key];
          const p = rates[key][i];
          if (!isNaN(k)) {
            total += logMultinomialLikelihood(k, n, p);
          }
        }
        return total;
      });

      // 尤度の指数を計算し、最大値基準で正規化
      const maxLog = Math.max(...logLs);
      const probs = logLs.map(l => Math.exp(l - maxLog));
      const sumProb = probs.reduce((a, b) => a + b, 0);
      const percents = probs.map(p => (p / sumProb * 100).toFixed(2));

      // 表示
      resultDiv.innerHTML = "<h3>判別結果</h3><ul>" +
        settings.map((s, i) => `<li>設定${s}: ${percents[i]}%</li>`).join("") +
        "</ul>";
    }
  </script>
</body>
</html>